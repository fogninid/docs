<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style type="text/css">
        body {
            background: white;
            color: black;
        }

        .scan {
            height: 150px;
            width: 150px;
            background: #ababab;
            display: inline-block;
            margin: 10px;
            padding: 10px;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress {
            background: #00aa00;
            height: 150px;
            border-radius: 8px;
            text-align: center;
        }

        .progress span {
            line-height: 150px;
        }

        .success {
            background: green;
        }

        .error {
            background: red;
        }
    </style>
</head>
<body>

<script src="js/jquery-3.2.1.min.js"></script>

<div>
    <form action="">
        <input id="scan" value="Scan" type="button">
    </form>
</div>
<div id="output"></div>

<script language="javascript" type="text/javascript">
  $(function() {
    var $out = $("#output");

    var pollProgress;
    pollProgress = function(id, progressUpdater) {
      $.ajax({url: "/scan/" + id})
        .then(function(scanStatus) {
          if (scanStatus.status === "error") {
            progressUpdater.error(scanStatus);
          } else {
            progressUpdater.success(scanStatus);
            if (scanStatus.status !== "success") {
              window.setTimeout(function() {
                pollProgress(id, progressUpdater);
              }, 500);
            }
          }
        })
        .catch(function(err) {
          progressUpdater.error(err);
        });
    };

    var addScanningElement = function() {
      var $div = $("<div class='scan'>");
      var $progress = $("<div class='progress'>");
      var $message = $("<span class='status'>");

      $progress.appendTo($div);
      $message.appendTo($progress);
      $div.appendTo($out);

      var setStatus = function(status) {
        switch (status) {
          case "started":
            $div.attr("class", "scan started");
            break;
          case "success":
            $progress.hide();
            $div.attr("class", "scan success");
            break;
          case "error":
          default:
            $progress.hide();
            $div.attr("class", "scan error");
        }
      };

      return {
        setStatus: setStatus,
        setError: function(err) {
          var message = err.message || err.cause || err.error;
          setStatus("error");
          $message.attr("title", message);
        },
        setProgress: function(progress) {
          $progress.css({width: progress + "%"});
        },
        setSize: function(size) {
          if (size) {

          }
        }
      };
    };

    $('#scan').click(function() {
      var scanningElement = addScanningElement();
      $.ajax({url: "/scan", method: "POST"})
        .then(function(data) {
          if ("id" in data) {
            var progress = 0;
            pollProgress(data.id, {
              success: function(scanStatus) {
                scanningElement.setStatus(scanStatus.status);
                if (scanStatus.progress > progress) {
                  progress = scanStatus.progress;
                  scanningElement.setProgress(progress);
                }
                scanningElement.setSize(scanStatus.size);
              },
              error: function(err) {
                scanningElement.setError(err);
              }
            });
          } else {
            scanningElement.setError("no id in response");
          }
        })
        .catch(function(err) {
          scanningElement.setError(err);
        });
    });
  });
</script>

</body>
</html>