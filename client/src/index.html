<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Document Scanner</title>
    <style type="text/css">
        body {
            background: white;
            color: black;
        }

        .scan {
            height: 150px;
            width: 150px;
            background: #ababab;
            display: inline-block;
            margin: 10px;
            padding: 10px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .scan .size {
            position: absolute;
            bottom: 15px;
            left: 15px;
        }

        .scan .status {
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translate(0, -50%);
        }

        #name {
            position: relative;
            margin: 5px;
            width: 130px;
            padding: 5px;
            background-color: #dbdbdb;
            color: #333333;
            border: 0;
        }

        #scan_button {
            box-sizing: border-box;
            margin: 15px auto;
            width: 80px;
            height: 80px;
            display: block;
            font-weight: bold;
            font-size: 22px;
            background-color: #dbdbdb;
            color: #333333;
            border: 0;
        }

        #scans {
            display: inline-block;
        }

        #repo-dir {
            text-align: center;
            width: 100%;
            height: 100%;
        }

        .success {
            background: green;
        }

        .error {
            background: red;
        }
    </style>
</head>
<body>

<script src="js/jquery-3.2.1.min.js"></script>

<div class="scan">
    <form id="scan_form" action="">
        <input id="name" value="" placeholder="name" type="text" autofocus>
        <input id="scan_button" value="Scan" type="button">
    </form>
</div>
<div class="scan">
    <a href="repo/">
        <div id="repo-dir">
            <span>scannerizzati</span>
        </div>
    </a>
</div>
<div id="scans">
</div>

<script language="javascript" type="text/javascript">
  $(function() {
    const $out = $("#scans");

    const delay = function(millis) {
      return new Promise(resolve => {
        window.setTimeout(resolve, millis);
      });
    };

    const pollProgress = (id, progressUpdater) => {
      return $.ajax({url: "/scan/" + id})
        .then(scanStatus => {
          if (progressUpdater.updateStatus(scanStatus)) {
            return delay(500)
              .then(() => pollProgress(id, progressUpdater));
          } else {
            return scanStatus;
          }
        })
        .catch(function(err) {
          progressUpdater.setError(err);
          throw err;
        });
    };

    const getProgressUpdater = (context) => {
      const cw = context.canvas.width;
      const ch = context.canvas.height;
      const cx = cw / 2;
      const cy = ch / 2;
      const sw = cx * 0.3;
      const cr = cx - sw;

      const offset = Math.PI * 1.5;
      return (value) => {
        const arcLen = ((value / 100) * Math.PI*2);
        context.clearRect(0, 0, cw, ch);
        context.lineWidth = sw;
        context.fillStyle = '#09F';
        context.strokeStyle = "#09F";
        context.textAlign = 'center';
        context.fillText(value+'%', cw*.5, ch*.5+2, cw);
        context.beginPath();
        context.arc(cx, cy, cr, offset, arcLen + offset, false);
        context.stroke();
      };
    };

    const addScanningElement = () => {
      const $div = $("<div class='scan'>");
      const $progress = $("<canvas width=150 height=150>");
      const $cont = $("<div class='container'>");
      const $message = $("<span class='status'>");
      const $size = $("<span class='size'>");

      $progress.appendTo($div);
      $message.appendTo($cont);
      $size.appendTo($cont);
      $cont.appendTo($div);
      $div.appendTo($out);

      const progressUpdater = getProgressUpdater($progress[0].getContext('2d'));

      const setStatus = status => {
        switch (status) {
          case "started":
            $div.attr("class", "scan started");
            return true;
          case "success":
            $div.attr("class", "scan success");
            return false;
          case "error":
          default:
            $progress.hide();
            $div.attr("class", "scan error");
            return false;
        }
      };

      let progress = 0;

      return {
        updateStatus: status => {
          if (status.progress > progress) {
            progress = status.progress;
            progressUpdater(progress);
          }

          if (status.size) {
            $size.text(status.size);
          }

          if (status.path) {
            const repoPath = "repo/" + status.path;
            const $l = $("<a>").attr("href", repoPath).text(status.path);
            $l.appendTo($message);
          }

          return setStatus(status.status);
        },
        setError: err => {
          const message = err.message || err.cause || err.error;
          setStatus("error");
          $message.attr("title", message);
        },
      };
    };

    const $name = $('#name');
    var scanning = false;
    const startScan = () => {
      if (scanning) {
        return false;
      }
      scanning = true;

      const scanningElement = addScanningElement();

      const data = {
        name: $name.val()
      };

      $.ajax({
        url: "/scan",
        method: "POST",
        data: JSON.stringify(data),
        contentType: "application/json",
        dataType: 'json'
      })
        .then(data => {
          if ("id" in data) {
            return data.id;
          } else {
            throw new Error("no id in response");
          }
        })
        .then(id => pollProgress(id, scanningElement))
        .catch(err => scanningElement.setError(err))
        .then(() => scanning = false);

      return false;
    };
    $('#scan_button').click(startScan);
    $('#scan_form').submit(startScan);
  });
</script>

</body>
</html>
